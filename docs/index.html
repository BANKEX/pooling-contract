<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>pooling-contract</title><link href="//cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" rel="stylesheet"/><link href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAOVBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAABMaXEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABlVggfAAAAE3RSTlPkZE7emXPXAMzHihi+QAwqs6mhB70WSgAAAQFJREFUOMuFk1mSwyAMRAUWhH3J/Q8bFikxNp7pn7hKL12qbgGvfwS/T6Utqfgd4DUYAt5qBziAgwwQ8x3I0DQtEFHdgdqBYVEbgPEKRBhqe4Y+R5cugJ0AtA0HgHIFBM1BT4Nm4RfAHCzFiguAhqQekvQ0D+kpajUB8dhFCn1e/ihLdIAWc3nXRTEGKXX+WIFoDP2xfq3We0A3f+WyzAnIM7tU+jZyA5y3/QVyA3xYI70BjkNfy5IsoVlurZtKxsC9g1zLonm1mi/nsoMkA8unFa9luWlgyaLecogdGFd/dMBvHg5iGYBpc7eJOuObXt4BOm0fbyDAwPZtvrxgnS/3AwT9GsisQa84AAAAAElFTkSuQmCC" rel="icon"/><style>@import url(https://fonts.googleapis.com/css?family=Roboto:400,700|Roboto+Mono);@media only screen and (max-width:767px){[class*="computer only"]:not(.mobile),[class*="large screen only"]:not(.mobile),[class*="mobile hidden"],[class*="or lower hidden"],[class*="tablet only"]:not(.mobile),[class*="widescreen only"]:not(.mobile){display:none!important}}@media only screen and (min-width:768px) and (max-width:991px){[class*="computer only"]:not(.tablet),[class*="large screen only"]:not(.tablet),[class*="mobile only"]:not(.tablet),[class*="or lower hidden"]:not(.mobile),[class*="tablet hidden"],[class*="widescreen only"]:not(.tablet){display:none!important}}@media only screen and (min-width:992px) and (max-width:1199px){[class*="computer hidden"],[class*="large screen only"]:not(.computer),[class*="mobile only"]:not(.computer),[class*="or lower hidden"]:not(.tablet):not(.mobile),[class*="tablet only"]:not(.computer),[class*="widescreen only"]:not(.computer){display:none!important}}@media only screen and (min-width:1200px) and (max-width:1919px){[class*="computer only"]:not([class*="large screen"]),[class*="large screen hidden"],[class*="mobile only"]:not([class*="large screen"]),[class*="or lower hidden"]:not(.computer):not(.tablet):not(.mobile),[class*="tablet only"]:not([class*="large screen"]),[class*="widescreen only"]:not([class*="large screen"]){display:none!important}}@media only screen and (min-width:1920px){[class*="computer only"]:not([class*=widescreen]),[class*="large screen only"]:not([class*=widescreen]),[class*="mobile only"]:not([class*=widescreen]),[class*="tablet only"]:not([class*=widescreen]),[class*="widescreen hidden"],[class*="widescreen or lower hidden"]{display:none!important}}.ui.header,.ui.menu,body,h1,h2,h3,h4,h5{font-family:Roboto,sans-serif}pre.wrap{white-space:pre-wrap;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;word-wrap:break-word}code{padding:0 .3em}code,pre{font-family:Roboto Mono,monospace;border:1px solid rgba(0,0,0,.05);background:rgba(0,0,0,.01)}code>code,pre>code{border:none;background:none}pre{padding:1em}.vertical.menu .item{overflow:hidden;text-overflow:ellipsis}.vertical.menu .item.active{overflow:visible}.pusher{display:flex;min-height:100vh;flex-direction:column}.pusher>.container:not(.footer){flex:1}.pusher>.footer{height:auto;margin-top:2em}.header code.signature{font-size:.6em}.ui.method-input{max-width:6em;overflow:hidden;text-overflow:ellipsis;text-align:right}.ui.method-input input{background:hsla(0,0%,100%,.7)}.hljs{display:block;overflow-x:auto;padding:.5em;color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style></head><body><div id="react-mount"><div style="padding-top:60px;" class="pusher" data-reactroot="" data-reactid="1" data-react-checksum="339725622"><div class="ui top fixed inverted menu" data-reactid="2"><div class="ui container" data-reactid="3"><a class="header item" href="/pooling-contract/" data-reactid="4"><!-- react-text: 5 -->pooling-contract<!-- /react-text --><div class="ui grey label" data-reactid="6">1.0.0</div></a><div class="item mobile hidden" data-reactid="7"><!-- react-text: 8 --><!-- /react-text --></div><div class="right menu" data-reactid="9"><a class="item" href="/pooling-contract/docs/ERC20/" data-reactid="10">Contracts</a></div></div></div><div class="ui container" data-reactid="11"><div class="markdown" data-reactid="12"><h1 data-reactid="13"></h1><div data-reactid="14"><h1>Pooling Smart Contract</h1>
<h2>About</h2>
<p>This is a developer guide. This guide will explain how to work with <em>pooling</em> and describe all it’s states, roles and models.</p>
<h2>What is pooling?</h2>
<hr>
<p>Pooling helps to collect a big sum of Ethereum from investors. Sometimes it’s impossible to invest in ICO because it’s not public and ICO creators are not interested in your small sum.</p>
<p>But if you definitely want to invest you can find a group of investors like you and collect a big sum of money which will be interesting for ICO creators.</p>
<p>So, with pooling contract you can easily collect money and invest it to ICO. If something went wrong pooling will refund money back. Moreover, pooling contract allows you to collect ETH even before the token creation.</p>
<h2>How it works (part 1: Roles)</h2>
<hr>
<p>In pooling contract there are <strong>stakeholders</strong> and <strong>investors</strong>.</p>
<p>Stakeholders:</p>
<ol>
<li>ADMIN (RL_ADMIN) - BANKEX manager who will create the contract</li>
<li>Pool manager (RL_POOL_MANAGER) - a person who will find investors and ICO to invest</li>
<li>ICO manager (RL_ICO_MANAGER) - a person who who tokens of target ICO and will sell tokens for ETH</li>
<li>Paybot (RL_PAYBOT) - it’s another account of ADMIN with some restrictions controlled by code</li>
</ol>
<p>All investors have Default role (RL_DEFAULT)</p>
<h2>How it works (part 2: States)</h2>
<hr>
<h4>Pooling contract have different states. Description:</h4>
<ol>
<li>ST_DEFAULT - Admin just created pooling contract</li>
<li>ST_RAISING - investors send ETH to pooling contract, only pool manager can start raising</li>
<li>ST_WAIT_FOR_ICO - target sum is collected and everybody are waiting for tokens from ICO manager</li>
<li>ST_MONEY_BACK (<strong>if something went wrong</strong>) - all collected sum is returned back to investors</li>
<li>ST_TOKEN_DISTRIBUTION - investors can get their tokens from contract and return some shortages of Ethereum if ICO manager did not get all the collected sum</li>
<li>ST_FUND_DEPRICATED - pooling contract death (occurred after amount of time called DISTRIBUTION_PERIOD)</li>
</ol>
<h4>Fund and time states:</h4>
<p>Every common state (<em>ST_DEFAULT, ST_RAISING,ST_WAIT_FOR_ICO and e.t.c</em>) are linked with other states (<em>Time and Fund states</em>).
<strong>For example:</strong> ST_WAIT_FOR_ICO can be occured <strong>only</strong> if fund state is <strong>RST_COLLECTED</strong></p>
<h5>Fund states:</h5>
<p><em>There are <strong>minimal</strong> and <strong>maximal</strong> size of fund int ETH</em></p>
<ol>
<li>RST_NOT_COLLECTED - if sum of ETH on contract is <strong>less</strong> than <strong>minimal</strong> fund size — <strong>(SUM &lt; MINIMAL)</strong></li>
<li>RST_COLLECTED - if sum of ETH on contract is <strong>less</strong> than <strong>maximal</strong> fund size <strong>but</strong> is more than <strong>minimal</strong> fund size — <strong>( MINIMAL &lt; SUM &lt; MAXIMAL )</strong></li>
<li>RST_FULL - if fum of ETH on contract is is more than <strong>maximal</strong> fund size — <strong>(SUM &gt; MAXIMAL)</strong></li>
</ol>
<h5>Time states:</h5>
<p><em>There are some periods, connected with time state (<strong>raisingPeriod</strong>, <strong>icoPeriod</strong>, <strong>distributionPeriod</strong>)</em></p>
<ol>
<li>TST_DEFAULT - when admin only created pooling contract</li>
<li>TST_RAISING - when pool manager start rasing money for ICO during <strong>raisingPeriod</strong></li>
<li>TST_WAIT_FOR_ICO - when <strong>raisingPeriod</strong> ends. This state continues during <strong>icoPeriod</strong></li>
<li>TST_TOKEN_DISTRIBUTION - when <strong>icoPeriod</strong> ends. This state continues during <strong>distributionPeriod</strong></li>
<li>TST_FUND_DEPRECATED - when <strong>distributionPeriod</strong> ends</li>
</ol>
<h4>Examples:</h4>
<h5>Example of lifecycle with states:</h5>
<ol>
<li>Pool manager finds ICO manager and investors and make an agreement (<em>minimal sum for ICO participation</em>, <em>amount of time to collected that sum</em>, percent for ICO manager and pool manager)</li>
<li>Admin create a pooling smart contract when pool manager asked him about it (<em>with all paramters in</em> <strong>1.</strong>) — <strong>ST_DEFAULT</strong></li>
<li>Pool manager starts raising state and all investors send Ethereum to pooling contract — <strong>ST_RAISING</strong></li>
<li>Minimal sum is collected and <strong>raisingPeriod</strong> ends, <strong>ICO_MANAGER</strong> can get ETH from pooling and send to it ERC20 tokens — <strong>ST_WAIT_FOR_ICO</strong></li>
<li><strong>ICO_MANAGER</strong> send tokens to contract, investors can get their tokens from contract — <strong>ST_TOKEN_DISTRIBUTION</strong></li>
<li>Token <strong>distributionPeriod</strong> ends and pooling contract is not working anymore. Only <strong>Admin</strong> can work with it. — <strong>ST_FUND_DEPRICATED</strong></li>
</ol>
<h5>Example of lifecycle with states (ST_MONEY_BACK case):</h5>
<ol>
<li>Pool manager finds ICO manager and investors and make an agreement (<em>minimal sum for ICO participation</em>, <em>amount of time to collected that sum</em>, percent for ICO manager and pool manager)</li>
<li>Admin create a pooling smart contract when pool manager asked him about it (<em>with all paramters in</em> <strong>1.</strong>) — <strong>ST_DEFAULT</strong></li>
<li>Pool manager starts raising state and all investors send Ethereum to pooling contract — <strong>ST_RAISING</strong></li>
<li>Minimal sum <strong>is not collected</strong> and <strong>raisingPeriod</strong> ends — <strong>ST_MONEY_BACK</strong></li>
<li>Investors get their Ethereum back from contract</li>
<li>After <strong>distributionPeriod</strong> ends and pooling contract is not working anymore. Only <strong>Admin</strong> can work with it. — <strong>ST_FUND_DEPRICATED</strong></li>
</ol>
<h4>Visualiation of states:</h4>
<p><img src="https://raw.githubusercontent.com/EnoRage/POA/master/POOLING.jpg" alt="Image of States"></p>
<h2>How it works (part 3: Shares)</h2>
<hr>
<p>Every stakeholder have it’s own share from all invested sum</p>
<ol>
<li>ADMIN - have 1% of all invested sum</li>
<li>Pool manager - have 4% of all invested sum</li>
<li>ICO manager have 95% of all invested sum</li>
</ol>
<h5>Calculation of stakeholders sum:</h5>
<p>There arent float varibles in Solidity, so we are using DECIMAL_MULTIPLIER == 10 ** 18
To calculate part of stake holder we need:
<strong>Stakeholder percent</strong> * <strong>total invested sum</strong> — <strong>sum that stake holder get back earlier</strong></p>
<p>But in <em>Solidity</em> it looks like:
<strong>total invested sum</strong> * (<strong>Stakeholder percent</strong> / <strong>DECIMAL_MULTIPLIER</strong>) — <strong>sum that stake holder get back earlier</strong>
Where <strong>Stakeholder percent</strong>  =  % * <strong>DECIMAL_MULTIPLIER</strong></p>
<h5>Calculation of investors tokens sum:</h5>
<p>To release tokens to investor in proportion to it’s invested sum of Ethereum we need:
<strong>All amount of tokens</strong> * (<strong>Investor sum</strong> / <strong>total invested sum</strong>) — <strong>sum that investor get back earlier</strong>
Amount of tokens and other variables here a multiplied by <strong>DECIMAL_MULTIPLIER</strong>, so float problem is solved</p>
<h5>Calculation of investors ethereum sum after ico manager release it’s share:</h5>
<p>Firstly, we need to get stakeholders part:
<strong>Stakeholders part</strong> = <strong>Sum that ICO manager released earlier</strong> * <strong>DECIMAL_MULTIPLIER</strong> / <strong>ICO manager part in percents</strong>
Secondly, we need to get ETH sum <strong>minus</strong> Stakeholders part:
<strong>Allowed sum</strong> = <strong>All invested sum</strong> - <strong>Stakeholders part</strong>
Thirdly, we get sum for investor:
<strong>Allowed sum</strong> * <strong>Invested sum of current investor</strong> / <strong>All invested sum</strong> — <strong>amount of ETH that investor released earlier</strong></p>
<h5>Calculation of investors ethereum sum in MONEY_BACK case:</h5>
<p>We just need to substract amount that investor want to get back from all amount that investor sent before:
<strong>Invested sum of current investor</strong> — <strong>Sum that investor want to get back</strong></p>
<h2>How it works (part 4: Ethereum and tokens)</h2>
<hr>
<ol>
<li>When pool state is <strong>ST_DEFAULT</strong> there aren’t any ETH or Tokens on contract</li>
<li>When pool state is <strong>ST_RAISING</strong> pooling has all ETH that investors sent</li>
<li>When pool state is <strong>ST_WAIT_FOR_ICO</strong> pooling contract allow ICO manager, Pool manager and Admin to release their ETH parts. ICO manager sent tokens to pooling contract</li>
<li>If pool state is <strong>ST_MONEY_BACK</strong> pooling contract allow investors to get all their ETH back</li>
<li>When pool state is <strong>ST_TOKEN_DISTRIBUTION</strong> pooling contract allow investors to release tokens and part of Ethereum that wasn’t taken by stakeholders</li>
<li>When pool state is <strong>ST_FUND_DEPRICATED</strong> pooling contract have all tokens and ETH that were not taken by investors and stakeholders. Only admin can release it.</li>
</ol>
<h4>Visualiation of cashflow:</h4>
<p><img src="https://raw.githubusercontent.com/EnoRage/POA/master/POOLING_CASHFLOW.jpg" alt="Image of cashflow"></p>
<h2>Using</h2>
<hr>
<p>You can find examples at: test/PoolTest.js</p>
<h5>Some small examples:</h5>
<p>Function <strong>setState()</strong> - change state of pooling</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> tbn = <span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> web3.toBigNumber(v);
<span class="hljs-keyword">const</span> POOL_MANAGER = accounts[<span class="hljs-number">1</span>];
<span class="hljs-keyword">const</span> ST_RAISING = tbn(<span class="hljs-number">0x01</span>);
... creation pool instance
<span class="hljs-keyword">async</span> () =&gt; {
   <span class="hljs-keyword">await</span> pool.setState(ST_RAISING, {<span class="hljs-attr">from</span>: POOL_MANAGER});
}
</code></pre>
<p>Function <strong>getStakeholderBalanceOf()</strong> is a <strong>.call()</strong> function that returns amount of ETH in <strong>WEI</strong> that current stakeholder can release</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> POOL_MANAGER = accounts[<span class="hljs-number">1</span>];
... creation pool instance
<span class="hljs-keyword">async</span> () =&gt; {
   <span class="hljs-keyword">await</span> pool.getStakeholderBalanceOf(RL_ICO_MANAGER);
}
</code></pre>
<h2>Deployment</h2>
<hr>
<h4>1. Create .env file with next content:</h4>
<pre><code class="language-javascript">ETH_KEY=PRIVATE_KEY
INFURA_TOKEN=TOKEN
</code></pre>
<p>Where <code>PRIVATE KEY</code> (without <code>0x</code>) is ethereum private key, from which contract will be deploy.<br>
And <code>TOKEN</code> is a unique string that gives access to send a transaction to rinkeby testnet.<br>
You may get this <code>TOKEN</code> after <a href="https://infura.io/">registration</a>.</p>
<h4>2. Use <code>truffle migrate --network rinkeby</code> to  deploy contract on rinkeby testnet.</h4>
<hr>
<p>Strictly recommended to use solium linter. <code>solium -d contracts</code></p>
<p>If you have compilation errors due to <code>emit Event</code> in solidity, update truffle.</p>
</div></div></div><div class="ui container footer" data-reactid="15"><div class="ui small top attached compact secondary segment" data-reactid="16"><div class="ui stackable grid" data-reactid="17"><div class="row" data-reactid="18"><div class="six wide column" data-reactid="19"><b data-reactid="20"><!-- react-text: 21 -->© <!-- /react-text --><!-- react-text: 22 --><!-- /react-text --></b><!-- react-text: 23 --> - <!-- /react-text --><!-- react-text: 24 -->ISC<!-- /react-text --><!-- react-text: 25 -->, <!-- /react-text --><!-- react-text: 26 -->2018<!-- /react-text --></div><div class="right aligned ten wide column" data-reactid="27"><!-- react-text: 28 -->Docs built using <!-- /react-text --><b data-reactid="29"><!-- react-text: 30 -->Solidity <!-- /react-text --></b><!-- react-text: 31 --> on <!-- /react-text --><b data-reactid="32">2018-6-20</b></div></div></div></div></div></div></div><script src="/pooling-contract/bundle.js?t=1529527115976"></script></body></html>